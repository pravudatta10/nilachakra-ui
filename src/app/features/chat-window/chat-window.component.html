<section class="chat-window" #scrollEl (scroll)="onScroll()">
  <!-- Centered inner wrapper so the overlay fills the viewport while chat stays centered -->
  <div class="chat-inner">

    <!-- Welcome message -->
    <div *ngIf="messages.length === 0" class="welcome-message">
      <h2 class="typing-effect">Hi</h2>
      <p>Welcome to Nilachakra AI. Feel free to ask me anything!</p>
    </div>

    <!-- Messages -->
    <div *ngFor="let m of messages; let i = index" class="message" [ngClass]="m.role">
      <div class="bubble">
        <!-- Render everything with markdown -->
        <markdown [data]="m.text"></markdown>

        <!-- Typing dots -->
        <span *ngIf="m.showThreeDots" class="typing-dots">
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </span>

        <div *ngIf="m.role === 'assistant' && !m.isTyping" class="message-footer-float">
          <!-- Copy button -->
          <span class="footer-btn cursor-pointer"
            [ngClass]="copiedIndex === i ? 'pi pi-check text-green-500' : 'pi pi-copy'" (click)="copyMessage(m, i)"
            pTooltip="{{ copiedIndex === i ? 'Copied!' : 'Copy to Clipboard' }}" tooltipPosition="top">
          </span>

          <!-- Regenerate button -->
          <span class="footer-btn pi pi-sync" (click)="regenerateMessage(m)" pTooltip="Regenerate Response"
            tooltipPosition="top">
          </span>

          <!-- Model name -->
          <div class="model-name">
            Generated by: {{ m.modelName }}
          </div>

          <!-- Like / Dislike icons -->
          <div class="like-dislike">
            <i class="pi pi-thumbs-up" (click)="likeMessage(m)"></i>
            <i class="pi pi-thumbs-down" (click)="dislikeMessage(m)"></i>
          </div>
        </div>

      </div>
    </div>


    <!-- Composer -->
    <div class="composer">
      <textarea pInputTextarea [(ngModel)]="userChatMsg" placeholder="Ask anything..." (keydown.enter)="onEnter($event)"
        (input)="autoGrow($event)" rows="2" class="chat-textarea"></textarea>
      <button pButton type="button" icon="pi pi-box" (click)="overlayPanel.toggle($event)" pTooltip="Select Model"
        tooltipPosition="top" tooltipEvent="hover"></button>
      <button pButton type="button" icon="pi pi-send" (click)="send()" *ngIf="!isStreaming"
        [disabled]="!userChatMsg.trim() || isSendDisabled"></button>
      <button pButton type="button" icon="pi pi-stop" (click)="stop()" *ngIf="isStreaming"></button>
    </div>

    <p-overlayPanel #overlayPanel [dismissable]="true" [style]="{'width':'320px'}">
      <div class="panel-content">
        <h3 class="panel-header">Select Model</h3>

        <div class="panel-items">
          <div class="panel-item" *ngFor="let model of models"
            [class.selected]="model.modelId === selectedModel.modelId" (click)="selectModel(model)">
            <span>{{ model.displayName }}</span>
            <i class="pi pi-check" *ngIf="model.modelId === selectedModel.modelId"></i>
          </div>
        </div>
      </div>
    </p-overlayPanel>

  </div>

</section>